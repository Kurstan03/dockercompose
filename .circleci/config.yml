## Use the latest 2.1 version of CircleCI pipeline process engine.
## See: https://circleci.com/docs/configuration-reference
#version: 2.1
#
## Define a job to be invoked later in a workflow.
## See: https://circleci.com/docs/configuration-reference/#jobs
#jobs:
#  say-hello:
#    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
#    # See: https://circleci.com/docs/configuration-reference/#executor-job
#    docker:
#      - image: cimg/base:stable
#    # Add steps to the job
#    # See: https://circleci.com/docs/configuration-reference/#steps
#    steps:
#      - checkout
#      - run:
#          name: "Say hello"
#          command: "echo Hello, World!"
#
## Orchestrate jobs using workflows
## See: https://circleci.com/docs/configuration-reference/#workflows
#workflows:
#  say-hello-workflow:
#    jobs:
#      - say-hello


version: 2.1

jobs:
  build-and-deploy:
    docker:
      - image: circleci/node:14
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build and Push Docker Image
          command: |
            docker build -t kurstan/my_app-backend:v1 .
            echo "$DOCKERHUB_PASSWORD" | docker login --username kurstan --password-stdin
            docker push kurstan/my_app-backend:v1
      - run:
          name: Install SSH And Configure
          command: |
            echo $SSH_PRIVATE_KEY | base64 --decode > ./erkinbaev.pem
            chmod 400 erkinbaev.pem
      - run:
          name: Pull Image and Deploy
          command: |
            ssh -o "StrictHostKeyChecking=no" -i erkinbaev.pem ubuntu@$HOST "sudo docker pull kurstan/my_app-backend:v1 && sudo docker run -d -p 2020:2020 kurstan/my_app-backend:v1"

workflows:
  version: 2
  deploy:
    jobs:
      - build-and-deploy:
          filters:
            branches:
              only: master
